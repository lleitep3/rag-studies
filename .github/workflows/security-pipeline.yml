name: üîí Security & Quality Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Executa semanalmente √†s segundas 02:00 UTC para verifica√ß√£o cont√≠nua
    - cron: '0 2 * * 1'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ==========================================
  # üìã SETUP E VALIDA√á√ïES B√ÅSICAS
  # ==========================================
  setup:
    name: üîß Setup & Basic Validation
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.setup.outputs.python-version }}
      cache-key: ${{ steps.setup.outputs.cache-key }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      id: setup-python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: üíæ Cache dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: pip-
        
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety bandit semgrep pytest pytest-cov flake8 mypy
        
    - name: ‚úÖ Validate project structure
      run: |
        echo "üîç Validating project structure..."
        test -f requirements.txt || (echo "‚ùå requirements.txt missing" && exit 1)
        test -d src || (echo "‚ùå src directory missing" && exit 1)
        test -f README.md || (echo "‚ùå README.md missing" && exit 1)
        echo "‚úÖ Project structure validated"
        
    - name: üìä Set outputs
      id: setup
      run: |
        echo "python-version=3.11" >> $GITHUB_OUTPUT
        echo "cache-key=pip-${{ hashFiles('**/requirements.txt') }}" >> $GITHUB_OUTPUT

  # ==========================================
  # üîç AN√ÅLISE EST√ÅTICA DE C√ìDIGO (SAST)
  # ==========================================
  sast:
    name: üîç Static Analysis Security Testing (SAST)
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}
        
    - name: üíæ Restore cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ needs.setup.outputs.cache-key }}
        
    - name: üì¶ Install SAST tools
      run: |
        pip install bandit[toml] semgrep safety mypy flake8 pylint
        
    # Bandit - Security linter espec√≠fico para Python
    - name: üõ°Ô∏è Run Bandit (Security Linter)
      run: |
        echo "üîç Running Bandit security analysis..."
        bandit -r src/ apps/ -f json -o bandit-report.json || true
        bandit -r src/ apps/ -f txt
        
    - name: üì§ Upload Bandit results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-results
        path: bandit-report.json
        
    # Semgrep - Static analysis com regras de seguran√ßa
    - name: ‚ö° Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/python
          p/bandit
        generateSarif: "1"
        
    - name: üì§ Upload Semgrep SARIF
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: semgrep.sarif
        
    # MyPy - Type checking
    - name: üî§ Run MyPy (Type Analysis)
      run: |
        echo "üî§ Running MyPy type analysis..."
        mypy src/ --ignore-missing-imports --show-error-codes --no-strict-optional || true
        
    # Pylint - Code quality e security patterns
    - name: üìù Run Pylint
      run: |
        echo "üìù Running Pylint analysis..."
        pylint src/ --output-format=json --reports=y > pylint-report.json || true
        pylint src/ --output-format=text
        
    - name: üì§ Upload Pylint results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: pylint-results
        path: pylint-report.json

  # ==========================================
  # üö® AN√ÅLISE DE VULNERABILIDADES
  # ==========================================
  vulnerability-scan:
    name: üö® Vulnerability Scanning
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}
        
    - name: üíæ Restore cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ needs.setup.outputs.cache-key }}
        
    - name: üì¶ Install dependencies
      run: |
        pip install -r requirements.txt
        pip install safety pip-audit
        
    # Safety - Vulnerabilidades conhecidas em depend√™ncias
    - name: üîí Run Safety (Dependency Vulnerabilities)
      run: |
        echo "üîí Scanning for known vulnerabilities..."
        safety check --json --output safety-report.json || true
        safety check --output text
        
    - name: üì§ Upload Safety results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: safety-results
        path: safety-report.json
        
    # Pip-audit - Scanner oficial do PyPA
    - name: üîç Run Pip-Audit
      run: |
        echo "üîç Running pip-audit scan..."
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit --format=columns
        
    - name: üì§ Upload Pip-Audit results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: pip-audit-results
        path: pip-audit-report.json
        
    # GitHub Security Advisory
    - name: üõ°Ô∏è GitHub Security Advisory
      uses: github/codeql-action/init@v2
      with:
        languages: python
        
    - name: üîç Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  # ==========================================
  # üß™ TESTES E COBERTURA
  # ==========================================
  testing:
    name: üß™ Testing & Coverage
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}
        
    - name: üíæ Restore cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ needs.setup.outputs.cache-key }}
        
    - name: üì¶ Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist pytest-mock coverage[toml]
        
    # Cria√ß√£o de testes b√°sicos se n√£o existirem
    - name: üîç Check for tests
      id: test-check
      run: |
        if [ ! -d "tests" ] && [ ! -f "test_*.py" ]; then
          echo "‚ö†Ô∏è No tests found. Creating basic test structure..."
          mkdir -p tests
          cat > tests/test_basic.py << 'EOF'
        """Basic tests for project structure"""
        import pytest
        import os
        from pathlib import Path

        def test_project_structure():
            """Test basic project structure exists"""
            assert Path("src").exists(), "src directory should exist"
            assert Path("README.md").exists(), "README.md should exist"
            assert Path("requirements.txt").exists(), "requirements.txt should exist"

        def test_src_modules():
            """Test src modules can be imported"""
            src_path = Path("src")
            assert src_path.exists()
            
            # Check for main modules
            expected_modules = ["loaders", "llms", "vector_stores", "core"]
            for module in expected_modules:
                module_path = src_path / module
                if module_path.exists():
                    assert (module_path / "__init__.py").exists(), f"{module} should be a proper Python package"

        def test_apps_structure():
            """Test apps structure"""
            apps_path = Path("apps")
            if apps_path.exists():
                assert Path("apps/README.md").exists(), "apps should have README"
        EOF
          echo "created=true" >> $GITHUB_OUTPUT
        else
          echo "created=false" >> $GITHUB_OUTPUT
        fi
        
    # Executar testes
    - name: üß™ Run tests with coverage
      run: |
        echo "üß™ Running tests with coverage..."
        if [ -d "tests" ] || ls test_*.py 2>/dev/null; then
          python -m pytest --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing -v
        else
          echo "‚ö†Ô∏è No tests found to run"
        fi
        
    - name: üì§ Upload coverage reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-results
        path: |
          coverage.xml
          htmlcov/
          
    # Codecov integration (opcional)
    - name: üìä Upload to Codecov
      uses: codecov/codecov-action@v3
      if: always() && hashFiles('coverage.xml') != ''
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ==========================================
  # üåê AN√ÅLISE DIN√ÇMICA (DAST)
  # ==========================================
  dast:
    name: üåê Dynamic Application Security Testing (DAST)
    runs-on: ubuntu-latest
    needs: [setup, sast]
    if: always() && !cancelled()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}
        
    - name: üì¶ Install dependencies
      run: |
        pip install -r requirements.txt
        pip install requests flask fastapi uvicorn
        
    # Simula√ß√£o de app web para DAST (se houver endpoints)
    - name: üåê Setup test server
      run: |
        echo "üåê Setting up test server for DAST..."
        cat > test_server.py << 'EOF'
        """Simple test server for DAST analysis"""
        from flask import Flask, request, jsonify
        import threading
        import time

        app = Flask(__name__)

        @app.route('/health')
        def health():
            return {'status': 'healthy'}

        @app.route('/api/query', methods=['POST'])
        def query():
            data = request.get_json()
            return {'result': f"Processed: {data}"}

        if __name__ == '__main__':
            app.run(host='0.0.0.0', port=5000, debug=False)
        EOF
        
        # Inicia servidor em background
        python test_server.py &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        sleep 5  # Aguarda servidor iniciar
        
    # OWASP ZAP Baseline scan
    - name: ‚ö° OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.9.0
      with:
        target: 'http://localhost:5000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        
    # Teste de endpoints b√°sico
    - name: üîç Basic endpoint security test
      run: |
        echo "üîç Testing basic endpoint security..."
        
        # Teste de SQL Injection b√°sico
        curl -X POST http://localhost:5000/api/query \
          -H "Content-Type: application/json" \
          -d '{"query": "'; DROP TABLE users; --"}' || true
          
        # Teste de XSS b√°sico
        curl -X POST http://localhost:5000/api/query \
          -H "Content-Type: application/json" \
          -d '{"query": "<script>alert('XSS')</script>"}' || true
          
        echo "‚úÖ Basic DAST tests completed"
        
    - name: üõë Cleanup test server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi

  # ==========================================
  # üìä RELAT√ìRIO CONSOLIDADO
  # ==========================================
  security-report:
    name: üìä Security Report
    runs-on: ubuntu-latest
    needs: [sast, vulnerability-scan, testing, dast]
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üì• Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: üìä Generate security report
      run: |
        echo "üìä Generating consolidated security report..."
        
        cat > security-report.md << 'EOF'
        # üîí Security Analysis Report
        
        ## üìã Pipeline Summary
        - **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Branch**: ${{ github.ref_name }}
        - **Commit**: ${{ github.sha }}
        - **Trigger**: ${{ github.event_name }}
        
        ## üîç Analysis Results
        
        ### ‚úÖ Completed Scans:
        - üõ°Ô∏è **SAST (Static Analysis)**: Bandit, Semgrep, MyPy, Pylint
        - üö® **Vulnerability Scanning**: Safety, Pip-Audit, CodeQL
        - üß™ **Testing**: Unit tests with coverage
        - üåê **DAST**: Basic endpoint testing
        
        ### üìÅ Generated Artifacts:
        EOF
        
        # Lista todos os artefatos encontrados
        echo "- üìÑ Generated artifacts:" >> security-report.md
        find . -name "*-results" -type d 2>/dev/null | while read dir; do
          echo "  - $(basename $dir)" >> security-report.md
        done
        
        # Adiciona m√©tricas b√°sicas se dispon√≠veis
        if [ -f "coverage.xml" ]; then
          echo "- üìä **Test Coverage**: Available" >> security-report.md
        fi
        
        echo "## üéØ Next Steps" >> security-report.md
        echo "1. Review all uploaded artifacts for detailed findings" >> security-report.md
        echo "2. Address any HIGH or CRITICAL severity issues" >> security-report.md
        echo "3. Update dependencies if vulnerabilities found" >> security-report.md
        echo "4. Consider adding more comprehensive tests" >> security-report.md
        
        cat security-report.md
        
    - name: üì§ Upload consolidated report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.md
        
    # Coment√°rio no PR com summary (se for PR)
    - name: üí¨ Comment PR with security summary
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('security-report.md')) {
            const report = fs.readFileSync('security-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }

  # ==========================================
  # ‚úÖ PIPELINE STATUS
  # ==========================================
  pipeline-status:
    name: ‚úÖ Pipeline Status
    runs-on: ubuntu-latest
    needs: [setup, sast, vulnerability-scan, testing, dast, security-report]
    if: always()
    
    steps:
    - name: üìä Pipeline Summary
      run: |
        echo "üîí Security Pipeline Completed!"
        echo "================================"
        echo "Setup: ${{ needs.setup.result }}"
        echo "SAST: ${{ needs.sast.result }}"
        echo "Vulnerability Scan: ${{ needs.vulnerability-scan.result }}"
        echo "Testing: ${{ needs.testing.result }}"
        echo "DAST: ${{ needs.dast.result }}"
        echo "Security Report: ${{ needs.security-report.result }}"
        echo "================================"
        
        # Falha se algum job cr√≠tico falhou
        if [[ "${{ needs.sast.result }}" == "failure" ]] || [[ "${{ needs.vulnerability-scan.result }}" == "failure" ]]; then
          echo "‚ùå Critical security checks failed!"
          exit 1
        else
          echo "‚úÖ Security pipeline passed!"
        fi